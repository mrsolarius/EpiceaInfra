services:
  nextcloud-db:
    image: postgres:16-alpine
    container_name: nextcloud_db
    restart: always
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 512M
        reservations:
          cpus: '0.1'
          memory: 128M
    environment:
      POSTGRES_DB: ${POSTGRES_DB}
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
    command: ["postgres", "-c", "shared_preload_libraries=pg_stat_statements"]
    volumes:
      - ${DATA_PATH}/nextcloud-db:/var/lib/postgresql/data
      - ./init-db.sql:/docker-entrypoint-initdb.d/init.sql
    networks:
      - default
      - proxy
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER} -d ${POSTGRES_DB}"]
      interval: 5s
      timeout: 5s
      retries: 5

  nextcloud:
    image: nextcloud:{{ docker_versions.nextcloud | default('32.0.5') }}
    container_name: nextcloud
    restart: always
    depends_on:
      nextcloud-db:
        condition: service_healthy
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 1G
        reservations:
          cpus: '0.2'
          memory: 512M
    env_file: .env
    environment:
      - POSTGRES_HOST=nextcloud-db
      - POSTGRES_DB=${POSTGRES_DB}
      - POSTGRES_USER=${POSTGRES_USER}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - REDIS_HOST=${REDIS_HOST}
      - REDIS_HOST_PASSWORD=${REDIS_HOST_PASSWORD}
      - NEXTCLOUD_ADMIN_USER=${NEXTCLOUD_ADMIN_USER}
      - NEXTCLOUD_ADMIN_PASSWORD=${NEXTCLOUD_ADMIN_PASSWORD}
      - NEXTCLOUD_TRUSTED_DOMAINS=${NEXTCLOUD_TRUSTED_DOMAINS}
      - NEXTCLOUD_DATA_DIR=${NEXTCLOUD_DATA_DIR}
      - OVERWRITECLIURL=https://${NEXTCLOUD_TRUSTED_DOMAINS}
      - OVERWRITEPROTOCOL=https
    volumes:
      - ${DATA_PATH}/nextcloud:/var/www/html
      - /mnt/cloud:/var/www/html/data
    networks:
      - default
      - proxy
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.nextcloud-http.rule=Host(`${NEXTCLOUD_TRUSTED_DOMAINS}`)"
      - "traefik.http.routers.nextcloud-http.entrypoints=web"
      - "traefik.http.routers.nextcloud-http.service=nextcloud"
      - "traefik.http.routers.nextcloud-https.rule=Host(`${NEXTCLOUD_TRUSTED_DOMAINS}`)"
      - "traefik.http.routers.nextcloud-https.entrypoints=websecure"
      - "traefik.http.routers.nextcloud-https.service=nextcloud"
      - "traefik.http.routers.nextcloud-https.tls=true"
{% if enable_letsencrypt %}
      - "traefik.http.routers.nextcloud-https.tls.certresolver=letsencrypt"
{% endif %}
      - "traefik.http.middlewares.nextcloud-dav.redirectregex.regex=^/.well-known/(card|cal)dav"
      - "traefik.http.middlewares.nextcloud-dav.redirectregex.replacement=/remote.php/dav/"
      - "traefik.http.routers.nextcloud-http.middlewares=nextcloud-dav"
      - "traefik.http.routers.nextcloud-https.middlewares=nextcloud-dav"
      - "traefik.http.services.nextcloud.loadbalancer.server.port=80"

networks:
  default:
  proxy:
    name: ${PROXY_NETWORK}
    external: true
