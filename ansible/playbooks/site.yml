---
- name: Epicea Infrastructure Deployment
  hosts: all
  become: true

  vars_files:
    - ../secrets/vault.yml

  pre_tasks:
    - name: V√©rification des pr√©requis
      ansible.builtin.assert:
        that:
          - ansible_facts['distribution'] == "Ubuntu"
          - ansible_facts['distribution_major_version'] | int >= 22
        fail_msg: "Ce playbook n√©cessite Ubuntu 22.04 ou sup√©rieur"

    - name: Afficher environnement d√©tect√©
      ansible.builtin.debug:
        msg:
          - "Environnement : {{ deploy_environment }}"
          - "GPU activ√© : {{ enable_gpu }}"
          - "Let's Encrypt : {{ enable_letsencrypt }}"

  roles:
    # Infrastructure de base
    - role: common
      tags: [common, base]

    - role: docker
      tags: [docker, base]

    - role: storage
      tags: [storage, base]

    # Reverse proxy
    - role: proxy
      tags: [proxy, services]
      when: "'traefik' in enabled_services"

    # Monitoring
    - role: monitoring
      tags: [monitoring, services]
      when: "'monitoring' in enabled_services"

    # Services partag√©s (BDD, Cache)
    - role: database
      tags: [database, services]
      when: "'shared-services' in enabled_services"

    # Applications
    - role: nextcloud
      tags: [nextcloud, services]
      when: "'nextcloud' in enabled_services"

    - role: immich
      tags: [immich, services]
      when: "'immich' in enabled_services"

  post_tasks:
    - name: V√©rifier que tous les services sont up
      ansible.builtin.command:
        cmd: docker ps --filter "name={{ item }}" --format "{{ '{{' }}.Names{{ '}}' }}"
      loop:
        - traefik
        - prometheus
        - grafana
        - postgres
        - redis
        - nextcloud
        - immich_server
      register: services_check
      changed_when: false
      failed_when: false

    - name: R√©sum√© du d√©ploiement
      ansible.builtin.debug:
        msg:
          - "================================================"
          - "‚úÖ D√©ploiement termin√© avec succ√®s !"
          - "================================================"
          - "Services d√©ploy√©s : {{ enabled_services | join(', ') }}"
          - "Environnement : {{ deploy_environment }}"
          - ""
          - "üîß Acc√®s services :"
          - "  Traefik   : {{ 'https' if enable_letsencrypt else 'http' }}://{{ service_domains.traefik }}"
          - "  Grafana   : {{ 'https' if enable_letsencrypt else 'http' }}://{{ service_domains.grafana }}"
          - "  Nextcloud : {{ 'https' if enable_letsencrypt else 'http' }}://{{ service_domains.nextcloud }}"
          - "  Immich    : {{ 'https' if enable_letsencrypt else 'http' }}://{{ service_domains.immich }}"
          - "  PgAdmin   : {{ 'https' if enable_letsencrypt else 'http' }}://pgadmin.{{ base_domain }}"
          - "  Redis Cmd : {{ 'https' if enable_letsencrypt else 'http' }}://redis.{{ base_domain }}"
          - ""
          - "üê≥ Services actifs :"
          - "{% for service in services_check.results %}  - {{ service.stdout | default('NOT RUNNING') }}{% endfor %}"
          - ""
          - "Prochaines √©tapes :"
          - "  make status  # V√©rifier les services"
          - "  make logs    # Voir les logs"
