---
- name: Epicea Infrastructure Deployment
  hosts: all
  become: true

  vars_files:
    - ../secrets/vault.yml

  pre_tasks:
    - name: V√©rification des pr√©requis
      ansible.builtin.assert:
        that:
          - ansible_distribution == "Ubuntu"
          - ansible_distribution_major_version | int >= 22
        fail_msg: "Ce playbook n√©cessite Ubuntu 22.04 ou sup√©rieur"

    - name: Afficher environnement d√©tect√©
      ansible.builtin.debug:
        msg:
          - "Environnement : {{ deploy_environment }}"
          - "GPU activ√© : {{ enable_gpu }}"
          - "Let's Encrypt : {{ enable_letsencrypt }}"

  roles:
    # Infrastructure de base
    - role: common
      tags: [common, base]

    - role: docker
      tags: [docker, base]

    - role: storage
      tags: [storage, base]

    # Reverse proxy
    - role: proxy
      tags: [proxy, services]
      when: "'traefik' in enabled_services"

    # Monitoring
    - role: monitoring
      tags: [monitoring, services]
      when: "'monitoring' in enabled_services"

  post_tasks:
    - name: R√©sum√© du d√©ploiement
      ansible.builtin.debug:
        msg:
          - "================================================"
          - "‚úÖ D√©ploiement termin√© avec succ√®s !"
          - "================================================"
          - "Services d√©ploy√©s : {{ enabled_services | join(', ') }}"
          - "Environnement : {{ deploy_environment }}"
          - ""
          - "üîß Acc√®s services :"
          - "  Traefik   : {{ 'https' if enable_letsencrypt else 'http' }}://{{ service_domains.traefik }}"
          - "  Grafana   : {{ 'https' if enable_letsencrypt else 'http' }}://{{ service_domains.grafana }}"
          - ""
          - "Prochaines √©tapes :"
          - "  make status  # V√©rifier les services"
          - "  make logs    # Voir les logs"
