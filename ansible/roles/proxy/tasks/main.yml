---
# ========================================
# Role: proxy (Traefik)
# Description: Déploiement reverse proxy Traefik
# ========================================

- name: Créer structure dossiers Traefik
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    mode: '0755'
    owner: "{{ system_user }}"
    group: "{{ system_group }}"
  loop:
    - "{{ storage.ansible.compose }}/traefik"
    - "{{ storage.ansible.compose }}/traefik/config"
    - "{{ storage.ansible.compose }}/traefik/config/dynamic"
    - "{{ storage.ansible.compose }}/traefik/letsencrypt"
    - "{{ storage.ansible.compose }}/traefik/logs"

- name: Configurer permissions acme.json (Let's Encrypt)
  ansible.builtin.file:
    path: "{{ storage.ansible.compose }}/traefik/letsencrypt/acme.json"
    state: touch
    mode: '0600'
    owner: "{{ system_user }}"
    group: "{{ system_group }}"
  when: proxy_enable_letsencrypt | bool

- name: Déployer configuration statique Traefik
  ansible.builtin.template:
    src: traefik.yml.j2
    dest: "{{ storage.ansible.compose }}/traefik/config/traefik.yml"
    mode: '0644'
    owner: "{{ system_user }}"
    group: "{{ system_group }}"
  notify: restart traefik

- name: Déployer middlewares dynamiques
  ansible.builtin.template:
    src: dynamic-middlewares.yml.j2
    dest: "{{ storage.ansible.compose }}/traefik/config/dynamic/middlewares.yml"
    mode: '0644'
    owner: "{{ system_user }}"
    group: "{{ system_group }}"
  notify: restart traefik

- name: Générer fichier .env Traefik
  ansible.builtin.template:
    src: proxy.env.j2
    dest: "{{ storage.ansible.compose }}/traefik/.env"
    mode: '0600'
    owner: "{{ system_user }}"
    group: "{{ system_group }}"
  notify: restart traefik

- name: Générer docker-compose.yml Traefik
  ansible.builtin.template:
    src: "{{ playbook_dir }}/../../docker/traefik/docker-compose.yml"
    dest: "{{ storage.ansible.compose }}/traefik/docker-compose.yml"
    mode: '0644'
    owner: "{{ system_user }}"
    group: "{{ system_group }}"
    trim_blocks: true
    lstrip_blocks: true
  notify: restart traefik

- name: Créer réseau Docker {{ proxy_network_name }}
  community.docker.docker_network:
    name: "{{ proxy_network_name }}"
    driver: bridge
    state: present

- name: Vérifier configuration Traefik (dry-run)
  ansible.builtin.command:
    cmd: docker compose config
    chdir: "{{ storage.ansible.compose }}/traefik"
  changed_when: false
  register: traefik_config_check
  failed_when: traefik_config_check.rc != 0

- name: Démarrer Traefik
  community.docker.docker_compose_v2:
    project_src: "{{ storage.ansible.compose }}/traefik"
    state: present
    remove_orphans: true
  register: traefik_deploy

- name: Attendre que Traefik soit up (Port 80)
  ansible.builtin.wait_for:
    host: localhost
    port: 80
    delay: 5
    timeout: 60
    state: started
  when: traefik_deploy.changed

- name: Attendre que l'API Traefik soit up (Port 8080)
  ansible.builtin.wait_for:
    host: localhost
    port: 8080
    delay: 2
    timeout: 30
    state: started
  when: traefik_deploy.changed

- name: Vérifier health check Traefik
  ansible.builtin.uri:
    url: "http://localhost:8080/ping"
    method: GET
    status_code: 200
  retries: 10
  delay: 3
  register: traefik_health
  until: traefik_health.status == 200

- name: Afficher statut Traefik
  ansible.builtin.debug:
    msg:
      - "✅ Traefik déployé avec succès"
      - "Dashboard: {{ 'https' if proxy_enable_letsencrypt else 'http' }}://{{ service_domains.traefik }}"
      - "Metrics: {{ 'https' if proxy_enable_letsencrypt else 'http' }}://{{ service_domains.traefik }}/metrics"
      - "Ping: {{ 'https' if proxy_enable_letsencrypt else 'http' }}://{{ service_domains.traefik }}/ping"
      - "Auth: {{ 'Configuré dans vault.yml' if deploy_environment == 'production' else 'admin / admin' }}"
