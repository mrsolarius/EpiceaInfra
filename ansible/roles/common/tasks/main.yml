---
# ========================================
# Role: common
# Description: Configuration système de base
# ========================================

- name: Mise à jour du système
  ansible.builtin.apt:
    upgrade: dist
    update_cache: true
    cache_valid_time: 3600

- name: Installation des paquets de base
  ansible.builtin.apt:
    name:
      - curl
      - wget
      - git
      - vim
      - htop
      - ncdu
      - tree
      - jq
      - unzip
      - ca-certificates
      - gnupg
      - lsb-release
      - ufw
      - fail2ban
      - nfs-common
      - prometheus-node-exporter
      - smartmontools
    state: present

- name: Configuration du service Node Exporter
  ansible.builtin.systemd:
    name: prometheus-node-exporter
    state: started
    enabled: true

- name: Configuration du timezone
  community.general.timezone:
    name: "{{ timezone }}"

# Les collections sont normalement gérées via ansible/requirements.yml
# On peut laisser cette tâche avec ignore_errors si on veut être sûr sur l'hôte de contrôle
# mais l'erreur 500 de Galaxy bloque le déploiement.
- name: Installation des collections Ansible
  ansible.builtin.command:
    cmd: ansible-galaxy collection install {{ item }}
  loop:
    - community.general
    - community.docker
    - ansible.posix
  changed_when: false
  become: false
  delegate_to: localhost
  run_once: true
  ignore_errors: true

- name: Configuration UFW - règles de base
  community.general.ufw:
    rule: "{{ item.rule }}"
    port: "{{ item.port }}"
    proto: "{{ item.proto | default('tcp') }}"
    comment: "{{ item.comment | default('') }}"
  loop:
    - { rule: 'allow', port: '22', comment: 'SSH' }
    - { rule: 'allow', port: '80', comment: 'HTTP' }
    - { rule: 'allow', port: '443', comment: 'HTTPS' }

- name: Configuration UFW - autoriser Node Exporter depuis le réseau local et Docker
  community.general.ufw:
    rule: allow
    port: '9100'
    proto: tcp
    from_ip: "{{ item }}"
    comment: 'Allow Node Exporter'
  loop:
    - '192.168.1.0/24'
    - '172.16.0.0/12'

- name: Configuration UFW - bloquer accès externe PostgreSQL, Redis et Node Exporter
  community.general.ufw:
    rule: deny
    port: "{{ item.port }}"
    proto: tcp
    comment: "{{ item.comment }}"
  loop:
    - { port: '5432', comment: 'Block external PostgreSQL' }
    - { port: '6379', comment: 'Block external Redis' }
    - { port: '9100', comment: 'Block external Node Exporter' }

- name: Configuration UFW - règles additionnelles (production)
  community.general.ufw:
    rule: "{{ item.rule }}"
    port: "{{ item.port | default(omit) }}"
    proto: "{{ item.proto | default('tcp') }}"
    from_ip: "{{ item.from | default(omit) }}"
    comment: "{{ item.comment | default('') }}"
  loop: "{{ ufw_additional_rules | default([]) }}"
  when: deploy_environment == 'production'

- name: Activation UFW
  community.general.ufw:
    state: enabled

- name: Configuration fail2ban
  ansible.builtin.systemd:
    name: fail2ban
    state: started
    enabled: true
  when: fail2ban_enabled | default(true)

- name: Configuration DNS local (test uniquement)
  ansible.builtin.lineinfile:
    path: /etc/hosts
    line: "127.0.0.1 {{ item }}"
    state: present
  loop:
    - "{{ service_domains.traefik }}"
    - "{{ service_domains.immich }}"
    - "{{ service_domains.jellyfin }}"
    - "{{ service_domains.nextcloud }}"
    - "{{ service_domains.grafana }}"
    - "{{ service_domains.dozzle }}"
  when: deploy_environment == 'test'

- name: Installer drivers NVIDIA (production avec GPU)
  ansible.builtin.apt:
    name:
      - nvidia-driver-{{ gpu_driver_version }}
      - nvidia-container-toolkit
    state: present
    update_cache: true
  when:
    - deploy_environment == 'production'
    - system_enable_gpu | bool
  notify: reboot system

- name: Afficher résumé configuration
  ansible.builtin.debug:
    msg:
      - "✅ Paquets de base installés"
      - "✅ Firewall UFW configuré"
      - "✅ Fail2ban activé"
      - "✅ Collections Ansible installées"
      - "{% if deploy_environment == 'test' %}✅ DNS local configuré{% endif %}"
      - "{% if system_enable_gpu %}✅ Drivers NVIDIA installés{% endif %}"
