groups:
  - name: postgresql_alerts
    interval: 30s
    rules:
      # PostgreSQL Instance Down
      - alert: PostgreSQLDown
        expr: pg_up{job="postgres"} == 0
        for: 1m
        labels:
          severity: critical
          component: postgresql
        annotations:
          summary: "PostgreSQL instance is down"
          description: "PostgreSQL instance {{ $labels.instance }} has been down for more than 1 minute."

      # High number of connections
      - alert: PostgreSQLTooManyConnections
        expr: sum(pg_stat_database_numbackends{datname!~"template.*"}) / pg_settings_max_connections * 100 > 80
        for: 5m
        labels:
          severity: warning
          component: postgresql
        annotations:
          summary: "PostgreSQL has too many connections"
          description: "PostgreSQL instance {{ $labels.instance }} is using {{ $value }}% of max connections."

      # Low cache hit ratio
      - alert: PostgreSQLLowCacheHitRatio
        expr: |
          100 * (sum(rate(pg_stat_database_blks_hit{datname!~"template.*"}[5m])) /
          (sum(rate(pg_stat_database_blks_hit{datname!~"template.*"}[5m])) +
          sum(rate(pg_stat_database_blks_read{datname!~"template.*"}[5m])))) < 90
        for: 10m
        labels:
          severity: warning
          component: postgresql
        annotations:
          summary: "PostgreSQL cache hit ratio is low"
          description: "PostgreSQL cache hit ratio is {{ $value }}% (should be > 90%). Consider increasing shared_buffers."

      # Deadlocks detected
      - alert: PostgreSQLDeadlocks
        expr: rate(pg_stat_database_deadlocks{datname!~"template.*"}[5m]) > 0
        for: 5m
        labels:
          severity: warning
          component: postgresql
        annotations:
          summary: "PostgreSQL deadlocks detected"
          description: "PostgreSQL database {{ $labels.datname }} has {{ $value }} deadlocks per second."

      # Long-running transactions
      - alert: PostgreSQLLongRunningTransactions
        expr: pg_long_running_transactions_transaction_duration_seconds > 1800
        for: 5m
        labels:
          severity: warning
          component: postgresql
        annotations:
          summary: "PostgreSQL has long-running transactions"
          description: "PostgreSQL transaction in database {{ $labels.datname }} by user {{ $labels.usename }} has been running for {{ $value }}s (> 30min)."

      # Idle in transaction sessions
      - alert: PostgreSQLIdleInTransaction
        expr: pg_stat_activity_sessions_idle_in_transaction > 5
        for: 10m
        labels:
          severity: warning
          component: postgresql
        annotations:
          summary: "PostgreSQL has idle in transaction sessions"
          description: "PostgreSQL database {{ $labels.datname }} has {{ $value }} sessions idle in transaction for more than 10 minutes."

      # High I/O wait time
      - alert: PostgreSQLHighIOWait
        expr: rate(pg_stat_database_blk_read_time{datname!~"template.*"}[5m]) + rate(pg_stat_database_blk_write_time{datname!~"template.*"}[5m]) > 1000
        for: 10m
        labels:
          severity: warning
          component: postgresql
        annotations:
          summary: "PostgreSQL high I/O wait time"
          description: "PostgreSQL database {{ $labels.datname }} is experiencing high I/O wait time: {{ $value }}ms. Consider investigating slow queries or disk performance."

      # Excessive temp file usage (disk spillage)
      - alert: PostgreSQLExcessiveTempFiles
        expr: rate(pg_stat_database_temp_bytes{datname!~"template.*"}[5m]) > 100000000
        for: 10m
        labels:
          severity: warning
          component: postgresql
        annotations:
          summary: "PostgreSQL excessive temp file usage"
          description: "PostgreSQL database {{ $labels.datname }} is writing {{ $value }} bytes/s to temp files. Queries may need optimization or work_mem increase."

      # Table bloat
      - alert: PostgreSQLTableBloat
        expr: pg_table_bloat_dead_tuple_percent > 20
        for: 1h
        labels:
          severity: warning
          component: postgresql
        annotations:
          summary: "PostgreSQL table has significant bloat"
          description: "Table {{ $labels.schemaname }}.{{ $labels.tablename }} has {{ $value }}% dead tuples. Consider running VACUUM."

      # Replication lag (if using replication)
      - alert: PostgreSQLReplicationLag
        expr: pg_replication_lag > 30
        for: 5m
        labels:
          severity: warning
          component: postgresql
        annotations:
          summary: "PostgreSQL replication lag detected"
          description: "PostgreSQL replication lag is {{ $value }} seconds on {{ $labels.instance }}."

      # Too many sequential scans on vector tables
      - alert: PostgreSQLVectorTableSeqScans
        expr: rate(pg_stat_user_tables_scan_ratio_seq_scan{schemaname="vectors"}[10m]) > rate(pg_stat_user_tables_scan_ratio_idx_scan{schemaname="vectors"}[10m])
        for: 15m
        labels:
          severity: info
          component: postgresql
          subsystem: pgvector
        annotations:
          summary: "Vector table experiencing too many sequential scans"
          description: "Vector table {{ $labels.tablename }} is using more sequential scans than index scans. Consider creating or rebuilding HNSW/IVFFlat indexes."

      # No vector index usage
      - alert: PostgreSQLVectorIndexUnused
        expr: pgvector_index_stats_idx_scan < 10 and pgvector_index_stats_index_size_bytes > 10000000
        for: 1h
        labels:
          severity: info
          component: postgresql
          subsystem: pgvector
        annotations:
          summary: "Large vector index is not being used"
          description: "Vector index {{ $labels.index_name }} on {{ $labels.table_name }} ({{ $labels.index_type }}) is large (>10MB) but has only {{ $value }} scans in the last hour."

      # High lock wait count
      - alert: PostgreSQLHighLockWaitCount
        expr: pg_locks_stats_locks_waiting > 10
        for: 5m
        labels:
          severity: warning
          component: postgresql
        annotations:
          summary: "PostgreSQL high lock wait count"
          description: "Database {{ $labels.datname }} has {{ $value }} locks waiting ({{ $labels.mode }} {{ $labels.locktype }})."
