groups:
  - name: postgresql_alerts
    interval: 30s
    rules:
      # PostgreSQL Instance Down
      - alert: PostgreSQLDown
        expr: pg_up{service="postgresql"} == 0
        for: 1m
        labels:
          severity: critical
          component: postgresql
        annotations:
          summary: "Instance PostgreSQL indisponible üî¥"
          description: "L'instance PostgreSQL {{ $labels.instance }} est indisponible depuis plus d'une minute."

      # High number of connections
      - alert: PostgreSQLTooManyConnections
        expr: sum(pg_stat_database_numbackends{datname!~"template.*"}) / pg_settings_max_connections * 100 > 80
        for: 5m
        labels:
          severity: warning
          component: postgresql
        annotations:
          summary: "Trop de connexions PostgreSQL üîå"
          description: "L'instance PostgreSQL {{ $labels.instance }} utilise {{ $value }}% des connexions maximales."

      # Low cache hit ratio
      - alert: PostgreSQLLowCacheHitRatio
        expr: |
          100 * (sum(rate(pg_stat_database_blks_hit{datname!~"template.*"}[5m])) /
          (sum(rate(pg_stat_database_blks_hit{datname!~"template.*"}[5m])) +
          sum(rate(pg_stat_database_blks_read{datname!~"template.*"}[5m])))) < 90
        for: 10m
        labels:
          severity: warning
          component: postgresql
        annotations:
          summary: "Faible taux de cache PostgreSQL üìâ"
          description: "Le taux de cache PostgreSQL est de {{ $value }}% (devrait √™tre > 90%). Envisagez d'augmenter shared_buffers."

      # Deadlocks detected
      - alert: PostgreSQLDeadlocks
        expr: rate(pg_stat_database_deadlocks{datname!~"template.*"}[5m]) > 0
        for: 5m
        labels:
          severity: warning
          component: postgresql
        annotations:
          summary: "Deadlocks PostgreSQL d√©tect√©s üîí"
          description: "La base de donn√©es PostgreSQL {{ $labels.datname }} a {{ $value }} deadlocks par seconde."

      # Long-running transactions
      - alert: PostgreSQLLongRunningTransactions
        expr: pg_long_running_transactions_transaction_duration_seconds > 1800
        for: 5m
        labels:
          severity: warning
          component: postgresql
        annotations:
          summary: "Transactions PostgreSQL longues ‚è≥"
          description: "Une transaction PostgreSQL dans la base {{ $labels.datname }} par l'utilisateur {{ $labels.usename }} tourne depuis {{ $value }}s (> 30min)."

      # Idle in transaction sessions
      - alert: PostgreSQLIdleInTransaction
        expr: pg_stat_activity_sessions_idle_in_transaction > 5
        for: 10m
        labels:
          severity: warning
          component: postgresql
        annotations:
          summary: "Sessions PostgreSQL inactives en transaction üí§"
          description: "La base de donn√©es PostgreSQL {{ $labels.datname }} a {{ $value }} sessions inactives en transaction depuis plus de 10 minutes."

      # High I/O wait time
      - alert: PostgreSQLHighIOWait
        expr: rate(pg_stat_database_blk_read_time{datname!~"template.*"}[5m]) + rate(pg_stat_database_blk_write_time{datname!~"template.*"}[5m]) > 1000
        for: 10m
        labels:
          severity: warning
          component: postgresql
        annotations:
          summary: "Temps d'attente E/S PostgreSQL √©lev√© üíæ"
          description: "La base de donn√©es PostgreSQL {{ $labels.datname }} subit un temps d'attente E/S √©lev√© : {{ $value }}ms. V√©rifiez les requ√™tes lentes ou la performance disque."

      # Excessive temp file usage (disk spillage)
      - alert: PostgreSQLExcessiveTempFiles
        expr: rate(pg_stat_database_temp_bytes{datname!~"template.*"}[5m]) > 100000000
        for: 10m
        labels:
          severity: warning
          component: postgresql
        annotations:
          summary: "Usage excessif de fichiers temporaires PostgreSQL üìÅ"
          description: "La base de donn√©es PostgreSQL {{ $labels.datname }} √©crit {{ $value }} octets/s dans des fichiers temporaires. Les requ√™tes n√©cessitent peut-√™tre une optimisation ou une augmentation de work_mem."

      # Table bloat
      - alert: PostgreSQLTableBloat
        expr: pg_table_bloat_dead_tuple_percent > 20
        for: 1h
        labels:
          severity: warning
          component: postgresql
        annotations:
          summary: "Table PostgreSQL gonfl√©e (bloat) üéà"
          description: "La table {{ $labels.schemaname }}.{{ $labels.tablename }} contient {{ $value }}% de tuples morts. Envisagez de lancer un VACUUM."

      # Replication lag (if using replication)
      - alert: PostgreSQLReplicationLag
        expr: pg_replication_lag > 30
        for: 5m
        labels:
          severity: warning
          component: postgresql
        annotations:
          summary: "Lag de r√©plication PostgreSQL d√©tect√© üê¢"
          description: "Le lag de r√©plication PostgreSQL est de {{ $value }} secondes sur {{ $labels.instance }}."

      # Too many sequential scans on vector tables
      - alert: PostgreSQLVectorTableSeqScans
        expr: rate(pg_stat_user_tables_scan_ratio_seq_scan{schemaname="vectors"}[10m]) > rate(pg_stat_user_tables_scan_ratio_idx_scan{schemaname="vectors"}[10m])
        for: 15m
        labels:
          severity: info
          component: postgresql
          subsystem: pgvector
        annotations:
          summary: "Trop de scans s√©quentiels sur table vectorielle üîç"
          description: "La table vectorielle {{ $labels.tablename }} utilise plus de scans s√©quentiels que de scans d'index. Envisagez de cr√©er ou reconstruire les index HNSW/IVFFlat."

      # No vector index usage
      - alert: PostgreSQLVectorIndexUnused
        expr: pgvector_index_stats_idx_scan < 10 and pgvector_index_stats_index_size_bytes > 10000000
        for: 1h
        labels:
          severity: info
          component: postgresql
          subsystem: pgvector
        annotations:
          summary: "Grand index vectoriel inutilis√© üóëÔ∏è"
          description: "L'index vectoriel {{ $labels.index_name }} sur {{ $labels.table_name }} ({{ $labels.index_type }}) est volumineux (>10Mo) mais n'a eu que {{ $value }} scans durant la derni√®re heure."

      # High lock wait count
      - alert: PostgreSQLHighLockWaitCount
        expr: pg_locks_stats_locks_waiting > 10
        for: 5m
        labels:
          severity: warning
          component: postgresql
        annotations:
          summary: "Nombre √©lev√© d'attentes de verrouillage PostgreSQL üîê"
          description: "La base de donn√©es {{ $labels.datname }} a {{ $value }} verrous en attente ({{ $labels.mode }} {{ $labels.locktype }})."
