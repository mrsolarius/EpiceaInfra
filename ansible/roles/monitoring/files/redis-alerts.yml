groups:
  - name: redis_alerts
    interval: 30s
    rules:
      # Redis Instance Down
      - alert: RedisDown
        expr: redis_up{job="redis"} == 0
        for: 1m
        labels:
          severity: critical
          component: redis
        annotations:
          summary: "Instance Redis indisponible üî¥"
          description: "L'instance Redis {{ $labels.instance }} est indisponible depuis plus d'une minute."

      # Low cache hit rate
      - alert: RedisLowCacheHitRate
        expr: |
          100 * rate(redis_keyspace_hits_total[5m]) /
          (rate(redis_keyspace_hits_total[5m]) + rate(redis_keyspace_misses_total[5m])) < 80
        for: 10m
        labels:
          severity: warning
          component: redis
        annotations:
          summary: "Faible taux de cache Redis üìâ"
          description: "L'instance Redis {{ $labels.instance }} a un taux de cache de {{ $value }}% (devrait √™tre > 80%). V√©rifiez les mod√®les d'utilisation des cl√©s."

      # High memory usage
      - alert: RedisHighMemoryUsage
        expr: (redis_memory_used_bytes / redis_memory_max_bytes) * 100 > 90
        for: 5m
        labels:
          severity: warning
          component: redis
        annotations:
          summary: "Utilisation m√©moire Redis √©lev√©e üíæ"
          description: "L'instance Redis {{ $labels.instance }} utilise {{ $value }}% de la m√©moire maximale. Des cl√©s pourraient commencer √† √™tre √©vinc√©es."

      # Memory fragmentation
      - alert: RedisHighMemoryFragmentation
        expr: redis_memory_fragmentation_ratio > 2
        for: 10m
        labels:
          severity: warning
          component: redis
        annotations:
          summary: "Fragmentation m√©moire Redis √©lev√©e üß©"
          description: "L'instance Redis {{ $labels.instance }} a un ratio de fragmentation de {{ $value }} (devrait √™tre < 1.5). Envisagez de red√©marrer Redis ou d'activer la d√©fragmentation active."

      # Low memory fragmentation (possible issue)
      - alert: RedisLowMemoryFragmentation
        expr: redis_memory_fragmentation_ratio < 0.7
        for: 10m
        labels:
          severity: info
          component: redis
        annotations:
          summary: "Fragmentation m√©moire Redis faible üìâ"
          description: "L'instance Redis {{ $labels.instance }} a un ratio de fragmentation de {{ $value }} (< 0.7). Cela peut indiquer que des pages m√©moire sont swapp√©es sur le disque."

      # Keys being evicted
      - alert: RedisKeysEvicted
        expr: rate(redis_evicted_keys_total[5m]) > 100
        for: 5m
        labels:
          severity: warning
          component: redis
        annotations:
          summary: "Redis √©vince des cl√©s üóëÔ∏è"
          description: "L'instance Redis {{ $labels.instance }} √©vince {{ $value }} cl√©s par seconde. Envisagez d'augmenter maxmemory ou de revoir les politiques TTL."

      # Too many connected clients
      - alert: RedisTooManyConnectedClients
        expr: redis_connected_clients > 100
        for: 5m
        labels:
          severity: warning
          component: redis
        annotations:
          summary: "Trop de clients connect√©s √† Redis üë•"
          description: "L'instance Redis {{ $labels.instance }} a {{ $value }} clients connect√©s. V√©rifiez s'il y a des fuites de connexion."

      # Blocked clients
      - alert: RedisBlockedClients
        expr: redis_blocked_clients > 5
        for: 5m
        labels:
          severity: warning
          component: redis
        annotations:
          summary: "Clients Redis bloqu√©s üö´"
          description: "L'instance Redis {{ $labels.instance }} a {{ $value }} clients bloqu√©s. V√©rifiez les op√©rations lentes ou les commandes bloquantes sur listes/streams."

      # Rejected connections
      - alert: RedisRejectedConnections
        expr: rate(redis_rejected_connections_total[5m]) > 0
        for: 5m
        labels:
          severity: warning
          component: redis
        annotations:
          summary: "Redis rejette des connexions ‚õî"
          description: "L'instance Redis {{ $labels.instance }} rejette {{ $value }} connexions par seconde. Envisagez d'augmenter maxclients."

      # Slow commands detected
      - alert: RedisSlowCommands
        expr: redis_slowlog_length > 10
        for: 5m
        labels:
          severity: info
          component: redis
        annotations:
          summary: "Commandes lentes Redis d√©tect√©es üê¢"
          description: "L'instance Redis {{ $labels.instance }} a {{ $value }} commandes lentes dans le slowlog. Examinez et optimisez les op√©rations lentes."

      # RDB save failures
      - alert: RedisRDBSaveFailure
        expr: redis_rdb_last_save_timestamp_seconds < (time() - 3600) and redis_rdb_changes_since_last_save > 1000
        for: 10m
        labels:
          severity: warning
          component: redis
        annotations:
          summary: "Sauvegarde RDB Redis non termin√©e r√©cemment üíæ"
          description: "L'instance Redis {{ $labels.instance }} n'a pas termin√© de sauvegarde RDB depuis plus d'une heure, et a des changements en attente."

      # AOF rewrite in progress for too long
      - alert: RedisAOFRewriteTooLong
        expr: redis_aof_rewrite_in_progress == 1
        for: 30m
        labels:
          severity: warning
          component: redis
        annotations:
          summary: "R√©√©criture AOF Redis trop longue ‚è≥"
          description: "L'instance Redis {{ $labels.instance }} r√©√©crit l'AOF depuis plus de 30 minutes."

      # High command latency
      - alert: RedisHighCommandLatency
        expr: |
          (redis_command_duration_seconds_sum / redis_command_duration_seconds_count) * 1000000 > 10000
        for: 10m
        labels:
          severity: warning
          component: redis
        annotations:
          summary: "Latence commande Redis √©lev√©e ‚è±Ô∏è"
          description: "La commande {{ $labels.cmd }} sur l'instance Redis {{ $labels.instance }} a une latence moyenne de {{ $value }}¬µs (> 10ms)."

      # High CPU usage
      - alert: RedisHighCPUUsage
        expr: rate(redis_cpu_sys_seconds_total[5m]) * 100 + rate(redis_cpu_user_seconds_total[5m]) * 100 > 80
        for: 10m
        labels:
          severity: warning
          component: redis
        annotations:
          summary: "Utilisation CPU Redis √©lev√©e üî•"
          description: "L'instance Redis {{ $labels.instance }} utilise {{ $value }}% du CPU. Enqu√™tez sur les op√©rations co√ªteuses."

      # No keys in Redis
      - alert: RedisNoKeys
        expr: sum(redis_db_keys) == 0
        for: 10m
        labels:
          severity: info
          component: redis
        annotations:
          summary: "Redis n'a aucune cl√© üì≠"
          description: "L'instance Redis {{ $labels.instance }} n'a aucune cl√©. Cela peut √™tre normal pour une nouvelle instance ou indiquer un probl√®me."

      # Master link down (replication)
      - alert: RedisMasterLinkDown
        expr: redis_master_link_up == 0
        for: 2m
        labels:
          severity: critical
          component: redis
        annotations:
          summary: "R√©plica Redis a perdu la connexion au ma√Ætre üîó"
          description: "Le r√©plica Redis {{ $labels.instance }} a perdu la connexion au ma√Ætre depuis plus de 2 minutes."

      # Network saturation
      - alert: RedisHighNetworkTraffic
        expr: rate(redis_net_input_bytes_total[5m]) + rate(redis_net_output_bytes_total[5m]) > 100000000
        for: 10m
        labels:
          severity: info
          component: redis
        annotations:
          summary: "Trafic r√©seau Redis √©lev√© üåê"
          description: "L'instance Redis {{ $labels.instance }} g√®re {{ $value }} octets/s de trafic r√©seau. Surveillez les goulots d'√©tranglement potentiels."
