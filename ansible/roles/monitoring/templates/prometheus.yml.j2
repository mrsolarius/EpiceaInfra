# ========================================
# Configuration Prometheus
# Générée par Ansible pour {{ deploy_environment }}
# ========================================

global:
  scrape_interval: {{ prometheus_scrape_interval | default('15s') }}
  evaluation_interval: {{ prometheus_evaluation_interval | default('15s') }}
  external_labels:
    environment: '{{ deploy_environment }}'
    cluster: 'epicea'

# Alertmanager configuration
alerting:
  alertmanagers:
    - static_configs:
        - targets:
          - alertmanager:9093

# Load rules once and periodically evaluate them
rule_files:
  - '/etc/prometheus/rules/*.yml'

# Scrape configurations
scrape_configs:
  # ========================================
  # Prometheus self-monitoring
  # ========================================
  - job_name: 'prometheus'
    static_configs:
      - targets: ['localhost:9090']
        labels:
          service: 'prometheus'
          environment: '{{ deploy_environment }}'

  # ========================================
  # Traefik metrics
  # ========================================
  - job_name: 'traefik'
    metrics_path: '/metrics'
    static_configs:
      - targets: ['traefik:8080'] # Port API/Metrics interne de Traefik
        labels:
          service: 'traefik'
          environment: '{{ deploy_environment }}'
          role: 'reverse-proxy'

  # ========================================
  # Node Exporter (Hôte Bare-metal)
  # ========================================
{% if prometheus_node_exporter_enabled | default(false) %}
  - job_name: 'node-exporter'
    static_configs:
      - targets: ['172.17.0.1:9100'] # IP Gateway Docker pour atteindre l'hôte
        labels:
          service: 'node-exporter'
          environment: '{{ deploy_environment }}'
          instance: '{{ ansible_facts["hostname"] }}'
{% endif %}

  # ========================================
  # cAdvisor (Docker metrics)
  # ========================================
  - job_name: 'cadvisor'
    static_configs:
      - targets: ['cadvisor:8080']
        labels:
          service: 'cadvisor'
          environment: '{{ deploy_environment }}'
    metric_relabel_configs:
      - source_labels: [container_label_com_docker_compose_service]
        target_label: name
        regex: (.+)
        replacement: $1
      - source_labels: [container_label_com_docker_compose_project]
        target_label: project
        regex: (.+)
        replacement: $1

  # ========================================
  # PostgreSQL Exporters
  # ========================================
  - job_name: 'postgres-nextcloud'
    static_configs:
      - targets: ['nextcloud-postgres-exporter:9187']
        labels:
          service: 'postgresql'
          environment: '{{ deploy_environment }}'
          instance: 'nextcloud'
    scrape_interval: 30s
    scrape_timeout: 10s

  - job_name: 'postgres-immich'
    static_configs:
      - targets: ['immich-postgres-exporter:9187']
        labels:
          service: 'postgresql'
          environment: '{{ deploy_environment }}'
          instance: 'immich'
    scrape_interval: 30s
    scrape_timeout: 10s

  # ========================================
  # Redis Exporter
  # ========================================
  - job_name: 'redis'
    static_configs:
      - targets: ['redis-exporter:9121']
        labels:
          service: 'redis'
          environment: '{{ deploy_environment }}'
          instance: 'redis-main'
    scrape_interval: 30s
    scrape_timeout: 10s

  # ========================================
  # Grafana self-monitoring (optionnel)
  # ========================================
  - job_name: 'grafana'
    static_configs:
      - targets: ['grafana:3000']
        labels:
          service: 'grafana'
          environment: '{{ deploy_environment }}'
    metrics_path: '/metrics'

  # ========================================
  # Services applicatifs (à ajouter)
  # ========================================
  # - job_name: 'nextcloud'
  #   static_configs:
  #     - targets: ['nextcloud:9091']
