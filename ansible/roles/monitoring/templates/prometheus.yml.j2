# ========================================
# Configuration Prometheus
# Générée par Ansible pour {{ deploy_environment }}
# ========================================

global:
  scrape_interval: {{ prometheus_scrape_interval | default('15s') }}
  evaluation_interval: {{ prometheus_evaluation_interval | default('15s') }}
  external_labels:
    environment: '{{ deploy_environment }}'
    cluster: 'epicea'

# Alertmanager configuration (optionnel)
# alerting:
#   alertmanagers:
#     - static_configs:
#         - targets:
#           - alertmanager:9093

# Load rules once and periodically evaluate them
# rule_files:
#   - "alerts/*.yml"

# Scrape configurations
scrape_configs:
  # ========================================
  # Prometheus self-monitoring
  # ========================================
  - job_name: 'prometheus'
    static_configs:
      - targets: ['localhost:9090']
        labels:
          service: 'prometheus'
          environment: '{{ deploy_environment }}'

  # ========================================
  # Traefik metrics
  # ========================================
  - job_name: 'traefik'
    metrics_path: '/metrics'
    static_configs:
      - targets: ['traefik:8080'] # Port API/Metrics interne de Traefik
        labels:
          service: 'traefik'
          environment: '{{ deploy_environment }}'
          role: 'reverse-proxy'

  # ========================================
  # Node Exporter (optionnel, si installé)
  # ========================================
{% if prometheus_node_exporter_enabled | default(false) %}
  - job_name: 'node-exporter'
    static_configs:
      - targets: ['node-exporter:9100']
        labels:
          service: 'node-exporter'
          environment: '{{ deploy_environment }}'
          instance: '{{ ansible_facts["hostname"] }}'
{% endif %}

  # ========================================
  # cAdvisor (Docker metrics)
  # ========================================
{% if prometheus_cadvisor_enabled | default(false) %}
  - job_name: 'cadvisor'
    static_configs:
      - targets: ['cadvisor:8080']
        labels:
          service: 'cadvisor'
          environment: '{{ deploy_environment }}'
{% endif %}

  # ========================================
  # Services applicatifs (à ajouter)
  # ========================================
  # - job_name: 'nextcloud'
  #   static_configs:
  #     - targets: ['nextcloud:9091']
