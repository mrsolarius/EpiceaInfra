---
# ========================================
# Role: monitoring (Prometheus + Grafana)
# Description: Stack de monitoring complète
# ========================================

- name: Créer structure dossiers Monitoring
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    mode: '0755'
    owner: root
    group: root
  loop:
    - "{{ docker_compose_path }}/monitoring"
    - "{{ docker_compose_path }}/monitoring/prometheus"
    - "{{ docker_compose_path }}/monitoring/prometheus/rules"
    - "{{ docker_compose_path }}/monitoring/alertmanager"
    - "{{ docker_compose_path }}/monitoring/postgres-exporter"
    - "{{ docker_compose_path }}/monitoring/grafana/provisioning/datasources"
    - "{{ docker_compose_path }}/monitoring/grafana/provisioning/dashboards"

- name: Déployer configuration Prometheus
  ansible.builtin.template:
    src: prometheus.yml.j2
    dest: "{{ docker_compose_path }}/monitoring/prometheus/prometheus.yml"
    mode: '0644'
    owner: root
    group: root
  notify: restart monitoring

- name: Déployer configuration Alertmanager
  ansible.builtin.template:
    src: alertmanager.yml.j2
    dest: "{{ docker_compose_path }}/monitoring/alertmanager/alertmanager.yml"
    mode: '0644'
    owner: root
    group: root
  notify: restart monitoring

- name: Déployer règles d'alerting PostgreSQL
  ansible.builtin.copy:
    src: postgres-alerts.yml
    dest: "{{ docker_compose_path }}/monitoring/prometheus/rules/postgres-alerts.yml"
    mode: '0644'
    owner: root
    group: root
  notify: restart monitoring

- name: Déployer règles d'alerting Redis
  ansible.builtin.copy:
    src: redis-alerts.yml
    dest: "{{ docker_compose_path }}/monitoring/prometheus/rules/redis-alerts.yml"
    mode: '0644'
    owner: root
    group: root
  notify: restart monitoring

- name: Déployer queries custom postgres-exporter
  ansible.builtin.copy:
    src: postgres-exporter-queries.yaml
    dest: "{{ docker_compose_path }}/monitoring/postgres-exporter/queries.yaml"
    mode: '0644'
    owner: root
    group: root
  notify: restart monitoring

- name: Déployer datasource Grafana (Prometheus)
  ansible.builtin.template:
    src: grafana-datasource.yml.j2
    dest: "{{ docker_compose_path }}/monitoring/grafana/provisioning/datasources/prometheus.yml"
    mode: '0644'
    owner: root
    group: root
  notify: restart monitoring

- name: Déployer provisioning dashboards Grafana
  ansible.builtin.template:
    src: grafana-dashboards.yml.j2
    dest: "{{ docker_compose_path }}/monitoring/grafana/provisioning/dashboards/dashboards.yml"
    mode: '0644'
    owner: root
    group: root
  notify: restart monitoring

- name: Déployer dashboard Traefik pour Grafana
  ansible.builtin.copy:
    src: traefik-dashboard.json
    dest: "{{ docker_compose_path }}/monitoring/grafana/provisioning/dashboards/traefik.json"
    mode: '0644'
    owner: root
    group: root
  notify: restart monitoring

- name: Déployer dashboard Docker pour Grafana
  ansible.builtin.copy:
    src: docker-dashboard.json
    dest: "{{ docker_compose_path }}/monitoring/grafana/provisioning/dashboards/docker.json"
    mode: '0644'
    owner: root
    group: root
  notify: restart monitoring

- name: Déployer dashboard PostgreSQL pour Grafana
  ansible.builtin.copy:
    src: postgresql-dashboard.json
    dest: "{{ docker_compose_path }}/monitoring/grafana/provisioning/dashboards/postgresql.json"
    mode: '0644'
    owner: root
    group: root
  notify: restart monitoring

- name: Déployer dashboard Redis pour Grafana
  ansible.builtin.copy:
    src: redis-dashboard.json
    dest: "{{ docker_compose_path }}/monitoring/grafana/provisioning/dashboards/redis.json"
    mode: '0644'
    owner: root
    group: root
  notify: restart monitoring

- name: Générer fichier .env Monitoring
  ansible.builtin.template:
    src: env.j2
    dest: "{{ docker_compose_path }}/monitoring/.env"
    mode: '0644'
    owner: root
    group: root
  notify: restart monitoring

- name: Générer docker-compose.yml Monitoring
  ansible.builtin.template:
    src: "{{ playbook_dir }}/../../docker/monitoring/docker-compose.yml"
    dest: "{{ docker_compose_path }}/monitoring/docker-compose.yml"
    mode: '0644'
    owner: root
    group: root
  notify: restart monitoring

- name: Vérifier configuration Monitoring (dry-run)
  ansible.builtin.command:
    cmd: docker compose config
    chdir: "{{ docker_compose_path }}/monitoring"
  changed_when: false
  register: monitoring_config_check
  failed_when: monitoring_config_check.rc != 0

- name: Démarrer stack Monitoring
  community.docker.docker_compose_v2:
    project_src: "{{ docker_compose_path }}/monitoring"
    state: present
    remove_orphans: true
  register: monitoring_deploy

- name: Vérifier que les conteneurs sont running
  ansible.builtin.shell:
    cmd: docker compose ps --format json | jq -r '.State' | grep -c running || true
    chdir: "{{ docker_compose_path }}/monitoring"
  register: monitoring_status
  until: monitoring_status.stdout | int > 0
  retries: 12
  delay: 5
  changed_when: false
  when: monitoring_deploy.changed

- name: Afficher statut Monitoring
  ansible.builtin.debug:
    msg:
      - "✅ Stack Monitoring déployée avec succès"
      - "Grafana: {{ 'https' if enable_letsencrypt else 'http' }}://{{ service_domains.grafana }}"
      - "User: {{ grafana_admin_user | default('admin') }}"
      - "Password: (voir vault.yml)"
      - ""
      - "Prometheus scrape Traefik metrics automatiquement"
