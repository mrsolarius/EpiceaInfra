---
# ========================================
# Role: monitoring (Prometheus + Grafana)
# Description: Stack de monitoring complète
# ========================================

- name: Créer structure dossiers Monitoring
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    mode: '0755'
    owner: "{{ common_system_user }}"
    group: "{{ common_system_group }}"
  loop:
    - "{{ storage.ansible.compose }}/monitoring"
    - "{{ storage.ansible.compose }}/monitoring/prometheus"
    - "{{ storage.ansible.compose }}/monitoring/prometheus/rules"
    - "{{ storage.ansible.compose }}/monitoring/alertmanager"
    - "{{ storage.ansible.compose }}/monitoring/loki"
    - "{{ storage.ansible.compose }}/monitoring/promtail"
    - "{{ storage.ansible.compose }}/monitoring/grafana/provisioning/datasources"
    - "{{ storage.ansible.compose }}/monitoring/grafana/provisioning/dashboards"
    - "{{ storage.monitoring }}/prometheus"
    - "{{ storage.monitoring }}/grafana"
    - "{{ storage.monitoring }}/loki"

- name: Déployer configuration Prometheus
  ansible.builtin.template:
    src: prometheus.yml.j2
    dest: "{{ storage.ansible.compose }}/monitoring/prometheus/prometheus.yml"
    mode: '0644'
    owner: "{{ common_system_user }}"
    group: "{{ common_system_group }}"
  notify: restart monitoring

- name: Déployer configuration Alertmanager
  ansible.builtin.template:
    src: alertmanager.yml.j2
    dest: "{{ storage.ansible.compose }}/monitoring/alertmanager/alertmanager.yml"
    mode: '0644'
    owner: "{{ common_system_user }}"
    group: "{{ common_system_group }}"
  notify: restart monitoring

- name: Déployer règles d'alerting PostgreSQL
  ansible.builtin.copy:
    src: postgres-alerts.yml
    dest: "{{ storage.ansible.compose }}/monitoring/prometheus/rules/postgres-alerts.yml"
    mode: '0644'
    owner: "{{ common_system_user }}"
    group: "{{ common_system_group }}"
  notify: restart monitoring

- name: Déployer règles d'alerting Redis
  ansible.builtin.copy:
    src: redis-alerts.yml
    dest: "{{ storage.ansible.compose }}/monitoring/prometheus/rules/redis-alerts.yml"
    mode: '0644'
    owner: "{{ common_system_user }}"
    group: "{{ common_system_group }}"
  notify: restart monitoring

- name: Déployer configuration Loki
  ansible.builtin.template:
    src: loki-config.yml.j2
    dest: "{{ storage.ansible.compose }}/monitoring/loki/loki-config.yml"
    mode: '0644'
    owner: "{{ common_system_user }}"
    group: "{{ common_system_group }}"
  notify: restart monitoring

- name: Déployer configuration Promtail
  ansible.builtin.template:
    src: promtail-config.yml.j2
    dest: "{{ storage.ansible.compose }}/monitoring/promtail/promtail-config.yml"
    mode: '0644'
    owner: "{{ common_system_user }}"
    group: "{{ common_system_group }}"
  notify: restart monitoring

- name: Déployer datasource Grafana (Prometheus)
  ansible.builtin.template:
    src: grafana-datasource.yml.j2
    dest: "{{ storage.ansible.compose }}/monitoring/grafana/provisioning/datasources/prometheus.yml"
    mode: '0644'
    owner: "{{ common_system_user }}"
    group: "{{ common_system_group }}"
  notify: restart monitoring

- name: Déployer provisioning dashboards Grafana
  ansible.builtin.template:
    src: grafana-dashboards.yml.j2
    dest: "{{ storage.ansible.compose }}/monitoring/grafana/provisioning/dashboards/dashboards.yml"
    mode: '0644'
    owner: "{{ common_system_user }}"
    group: "{{ common_system_group }}"
  notify: restart monitoring

- name: Déployer dashboard Traefik pour Grafana
  ansible.builtin.copy:
    src: traefik-dashboard.json
    dest: "{{ storage.ansible.compose }}/monitoring/grafana/provisioning/dashboards/traefik.json"
    mode: '0644'
    owner: "{{ common_system_user }}"
    group: "{{ common_system_group }}"
  notify: restart monitoring

- name: Déployer dashboard Docker pour Grafana
  ansible.builtin.copy:
    src: docker-dashboard.json
    dest: "{{ storage.ansible.compose }}/monitoring/grafana/provisioning/dashboards/docker.json"
    mode: '0644'
    owner: "{{ common_system_user }}"
    group: "{{ common_system_group }}"
  notify: restart monitoring

- name: Déployer dashboard PostgreSQL pour Grafana
  ansible.builtin.copy:
    src: postgresql-dashboard.json
    dest: "{{ storage.ansible.compose }}/monitoring/grafana/provisioning/dashboards/postgresql.json"
    mode: '0644'
    owner: "{{ common_system_user }}"
    group: "{{ common_system_group }}"
  notify: restart monitoring

- name: Déployer dashboard Redis pour Grafana
  ansible.builtin.copy:
    src: redis-dashboard.json
    dest: "{{ storage.ansible.compose }}/monitoring/grafana/provisioning/dashboards/redis.json"
    mode: '0644'
    owner: "{{ common_system_user }}"
    group: "{{ common_system_group }}"
  notify: restart monitoring

- name: Déployer dashboard Bare Metal & NFS pour Grafana
  ansible.builtin.copy:
    src: node-exporter-dashboard.json
    dest: "{{ storage.ansible.compose }}/monitoring/grafana/provisioning/dashboards/node-exporter.json"
    mode: '0644'
    owner: "{{ common_system_user }}"
    group: "{{ common_system_group }}"
  notify: restart monitoring

- name: Générer fichier .env Monitoring
  ansible.builtin.template:
    src: monitoring.env.j2
    dest: "{{ storage.ansible.compose }}/monitoring/.env"
    mode: '0644'
    owner: "{{ common_system_user }}"
    group: "{{ common_system_group }}"
  notify: restart monitoring

- name: Générer docker-compose.yml Monitoring
  ansible.builtin.template:
    src: "{{ playbook_dir }}/../../docker/monitoring/docker-compose.yml"
    dest: "{{ storage.ansible.compose }}/monitoring/docker-compose.yml"
    mode: '0644'
    owner: "{{ common_system_user }}"
    group: "{{ common_system_group }}"
    trim_blocks: true
    lstrip_blocks: true
  notify: restart monitoring

- name: Vérifier configuration Monitoring (dry-run)
  ansible.builtin.command:
    cmd: docker compose config
    chdir: "{{ storage.ansible.compose }}/monitoring"
  changed_when: false
  register: monitoring_config_check
  failed_when: monitoring_config_check.rc != 0

- name: Démarrer stack Monitoring
  community.docker.docker_compose_v2:
    project_src: "{{ storage.ansible.compose }}/monitoring"
    state: present
    remove_orphans: true
    recreate: always
  register: monitoring_deploy
  ignore_errors: true

- name: Afficher logs Loki en cas d'échec (stdout + stderr)
  ansible.builtin.shell:
    cmd: docker logs loki 2>&1 | tail -100 || echo "Impossible de récupérer les logs"
  register: loki_logs
  when: monitoring_deploy.failed | default(false)
  ignore_errors: true

- name: Debug logs Loki complets
  ansible.builtin.debug:
    msg: "{{ loki_logs.stdout }}"
  when: monitoring_deploy.failed | default(false)

- name: Fail si monitoring ne démarre pas
  ansible.builtin.fail:
    msg: "Échec du démarrage de la stack Monitoring. Voir les logs ci-dessus."
  when: monitoring_deploy.failed | default(false)

- name: Vérifier que les conteneurs sont running
  ansible.builtin.shell:
    cmd: docker compose ps --format json | jq -r '.State' | grep -c running || true
    chdir: "{{ storage.ansible.compose }}/monitoring"
  register: monitoring_status
  until: monitoring_status.stdout | int > 0
  retries: 12
  delay: 5
  changed_when: false
  when: monitoring_deploy.changed

- name: Afficher statut Monitoring
  ansible.builtin.debug:
    msg:
      - "✅ Stack Monitoring déployée avec succès"
      - "Grafana: {{ 'https' if proxy_enable_letsencrypt else 'http' }}://{{ service_domains.grafana }}"
      - "User: {{ monitoring_grafana_admin_user | default('admin') }}"
      - "Password: (voir vault.yml)"
      - ""
      - "Prometheus scrape Traefik metrics automatiquement"
